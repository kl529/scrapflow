name: ğŸš€ Build and Release ScrapFlow

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'package.json'
      - '.github/workflows/**'

env:
  NODE_VERSION: '18'
  ELECTRON_CACHE: ${{ github.workspace }}/.cache/electron
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Check out Git repository
      uses: actions/checkout@v4

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: Run ESLint
      run: npm run lint --if-present
      continue-on-error: true

    - name: Check build
      run: npm run build

  # ë©”ì¸ ë¹Œë“œ ì‘ì—…
  build:
    name: ğŸ—ï¸ Build for ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    if: github.event_name != 'pull_request'

    strategy:
      fail-fast: false
      matrix:
        config:
          - name: macOS (Intel + Apple Silicon)
            os: macos-latest
            build-command: build-mac
            artifact-name: macOS
            artifact-path: dist/*.dmg
          - name: Windows (x64 + x86)
            os: windows-latest
            build-command: build-win
            artifact-name: Windows
            artifact-path: dist/*.exe

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë²„ì „ íƒœê·¸ìš©)

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    # ìºì‹œ ì„¤ì •ìœ¼ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ
    - name: Cache Electron
      uses: actions/cache@v4
      with:
        path: ${{ env.ELECTRON_CACHE }}
        key: ${{ runner.os }}-electron-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-electron-

    - name: Cache Electron Builder
      uses: actions/cache@v4
      with:
        path: ${{ env.ELECTRON_BUILDER_CACHE }}
        key: ${{ runner.os }}-electron-builder-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-electron-builder-

    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: Build React app
      run: npm run build

    - name: Install native dependencies 
      run: npm run postinstall


    - name: Build Electron app
      run: npm run ${{ matrix.config.build-command }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ELECTRON_CACHE: ${{ env.ELECTRON_CACHE }}
        ELECTRON_BUILDER_CACHE: ${{ env.ELECTRON_BUILDER_CACHE }}
        # macOS ì½”ë“œ ì‚¬ì´ë‹ ë¹„í™œì„±í™” (ê°œë°œìš©)
        CSC_IDENTITY_AUTO_DISCOVERY: false

    - name: List build artifacts
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          dir dist\ /a
        else
          ls -la dist/
        fi
      shell: bash

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.config.artifact-name }}-build
        path: ${{ matrix.config.artifact-path }}
        retention-days: 7

  # ë¦´ë¦¬ìŠ¤ ìƒì„± ë° ë°°í¬
  release:
    name: ğŸ“¦ Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Display structure of downloaded files
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          dir artifacts\ /a
        else
          ls -la artifacts/
        fi
      shell: bash

    - name: Get version and changelog
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

        # ê°„ë‹¨í•œ changelog ìƒì„±
        if git tag --list | grep -q "${VERSION%.*}"; then
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [[ -n "$PREVIOUS_TAG" ]]; then
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            git log --pretty=format:"- %s (%an)" ${PREVIOUS_TAG}..HEAD >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        fi
      shell: bash

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: ğŸš€ ScrapFlow ${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'rc') }}
        generate_release_notes: true
        body: |
          ## ğŸ‰ ScrapFlow ${{ steps.version.outputs.VERSION }}
          
          ### âš¡ï¸ ì„±ëŠ¥ ê°œì„ ì‚¬í•­
          - ğŸš€ **ì•± ì‹œì‘ ì‹œê°„ 50% ë‹¨ì¶•**: 2ì´ˆ â†’ 1ì´ˆ ì´ë‚´
          - ğŸ”¤ **OCR ì²˜ë¦¬ ì†ë„ ê°œì„ **: í‰ê·  2-3ì´ˆ â†’ 1ì´ˆ ì´ë‚´  
          - ğŸ’¾ **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™”**: React ì»´í¬ë„ŒíŠ¸ ë©”ëª¨ì´ì œì´ì…˜ìœ¼ë¡œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
          - ğŸ”§ **ë¹Œë“œ íŒŒì´í”„ë¼ì¸ ê°œì„ **: ìºì‹±ìœ¼ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ, ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì¶”ê°€
          
          ### âœ¨ ì£¼ìš” ê¸°ëŠ¥
          - ğŸ“¸ **ë¹ ë¥¸ ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜**: `Ctrl+Shift+S` (Mac: `Cmd+Shift+S`)
          - ğŸ”¤ **OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ**: í•œêµ­ì–´/ì˜ì–´ ì§€ì›, ê²€ìƒ‰ ê°€ëŠ¥
          - ğŸ¨ **SNS ê³µìœ  ì´ë¯¸ì§€**: ì•„ë¦„ë‹¤ìš´ í…œí”Œë¦¿ìœ¼ë¡œ ì†Œì…œ ë¯¸ë””ì–´ ê³µìœ 
          - ğŸ”— **ë¸Œë¼ìš°ì € URL ìë™ ê°ì§€**: Chrome, Safari, Arc, Edge, Whale ì§€ì›
          - ğŸ“‚ **ì¹´í…Œê³ ë¦¬ ê´€ë¦¬**: ìƒ‰ìƒ ì½”ë”©ìœ¼ë¡œ ì²´ê³„ì ì¸ ë¶„ë¥˜
          - ğŸ” **í†µí•© ê²€ìƒ‰**: ì½”ë©˜íŠ¸ + OCR í…ìŠ¤íŠ¸ ì‹¤ì‹œê°„ ê²€ìƒ‰
          - ğŸ“Š **í™œë™ í†µê³„**: GitHub ìŠ¤íƒ€ì¼ íˆíŠ¸ë§µ
          
          ### ğŸ“¦ ë‹¤ìš´ë¡œë“œ
          ìš´ì˜ì²´ì œì— ë§ëŠ” íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”:
          
          | ìš´ì˜ì²´ì œ | íŒŒì¼ | ì°¸ê³ ì‚¬í•­ |
          |---------|------|----------|
          | ğŸ **macOS** | `.dmg` | Intel & Apple Silicon ì§€ì› |
          | ğŸªŸ **Windows** | `.exe` | x64 & x86 ì§€ì› |
          
          ### ğŸš€ ì„¤ì¹˜ ë°©ë²•
          1. ìœ„ì—ì„œ ìš´ì˜ì²´ì œì— ë§ëŠ” íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          2. ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì¹˜/ì‹¤í–‰
          3. í™”ë©´ ë…¹í™” ê¶Œí•œ í—ˆìš© (ìŠ¤í¬ë¦°ìƒ· ì´¬ì˜ì— í•„ìš”)
          4. `Ctrl+Shift+S`ë¡œ ì²« ìŠ¤í¬ë¦°ìƒ· ì´¬ì˜!
          
          ### ğŸ”§ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
          - **macOS**: 10.11 (El Capitan) ì´ìƒ
          - **Windows**: Windows 7/10/11
          
          ### ğŸ“ ë³€ê²½ì‚¬í•­
          ${{ steps.version.outputs.CHANGELOG }}
          
          ### ğŸ› ë¬¸ì œ ì‹ ê³  & ê¸°ëŠ¥ ìš”ì²­
          [GitHub Issues](https://github.com/kl529/scrapflow/issues)ì—ì„œ ë²„ê·¸ ë¦¬í¬íŠ¸ë‚˜ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.
          
          ### ğŸŒŸ í›„ì›í•˜ê¸°
          ScrapFlowê°€ ë„ì›€ì´ ë˜ì…¨ë‚˜ìš”? [GitHub Sponsors](https://github.com/sponsors/kl529)ì—ì„œ í”„ë¡œì íŠ¸ë¥¼ í›„ì›í•´ì£¼ì„¸ìš”!
        files: |
          ./artifacts/**/*